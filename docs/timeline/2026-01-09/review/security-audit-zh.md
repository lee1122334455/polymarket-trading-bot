# Polymarket 交易机器人 - 安全审计报告

```
Status: done
Owner: Claude + Codex
LastUpdated: 2026-01-09
```

---

## 写在前面：这份报告是什么？

这份报告检查了你的交易机器人代码中可能存在的安全隐患。

**简单来说**：我们检查了你的"钱包钥匙"（私钥）和"API密码"是否安全，以及代码中有没有可能被坏人利用的漏洞。

---

## 安全问题总览

我们把问题分成三个等级：

| 等级 | 含义 | 比喻 |
|------|------|------|
| **高危** | 必须马上修复 | 家门没锁 |
| **中危** | 应该尽快修复 | 窗户有缝隙 |
| **低危** | 建议修复 | 门垫下面藏钥匙 |

**统计**：高危 2 个 | 中危 5 个 | 低危 1 个

---

## 高危问题 (2个)

### 问题1：网络连接可能不安全

**通俗解释**：
想象你在咖啡店用WiFi给银行打电话，如果电话没加密，旁边的人可能偷听到你的银行卡密码。

**技术细节**：
- 代码只检查网址是不是 `http` 开头，但 `http://` 和 `https://` 都能通过
- `http://` 是明文传输（不安全），`https://` 才是加密传输（安全）
- 你的API密钥如果走 `http://` 传输，就像在马路上大喊你的密码

**涉及文件**：
- `src/config.py` 第112-114行

```python
# 目前的代码：
def is_valid(self) -> bool:
    return bool(self.host and self.host.startswith("http"))  # http和https都能过！
```

**建议修复**：
```python
# 应该改成：
def is_valid(self) -> bool:
    return bool(self.host and self.host.startswith("https://"))  # 只允许https
```

**风险程度**：目前默认配置使用的是 `https://`，所以实际风险不高。但如果有人不小心配置成 `http://`，就会有问题。

---

### 问题2：配置文件保存时没有加密

**通俗解释**：
你把银行卡密码写在一张纸上，然后放在抽屉里。虽然抽屉关着，但任何能打开抽屉的人都能看到密码。

**技术细节**：
- `Config.save()` 方法会把 Builder API 凭证（相当于你的交易密码）以明文形式保存到 YAML 文件
- 这个文件没有设置权限限制，任何能登录你电脑的人都能看到

**涉及文件**：
- `src/config.py` 第381-388行

```python
def save(self, filepath: str = "config.yaml") -> None:
    data = self.to_dict()  # 包含 builder.api_key, api_secret 等敏感信息
    # ...
    with open(path, 'w') as f:
        yaml.dump(data, f, ...)  # 直接明文保存！
    # 没有设置文件权限！
```

**好消息**：私钥的保存（`encrypt_and_save`）是安全的，有加密并且设置了权限 `0o600`（只有你能读）。

**建议修复**：
1. 不要把 API 凭证保存到文件，只用环境变量
2. 如果必须保存，至少设置文件权限为 `0o600`

---

## 中危问题 (5个)

### 问题3：加密盐重复使用风险

**通俗解释**：
加密时用的"盐"就像做菜时的调料配方。如果每次都用同样的配方，别人更容易猜出你的秘方。加密也是一样，每次加密应该用不同的"盐"。

**技术细节**：
- `KeyManager` 在创建时生成一个随机盐
- 如果同一个实例多次调用 `encrypt()`，会重复使用同一个盐
- 这降低了密码派生的安全性

**涉及文件**：
- `src/crypto.py` 第63-65行

**好消息**：实际使用中通常每次加密都创建新实例，所以风险较低。

**建议**：每次调用 `encrypt()` 前自动调用 `generate_new_salt()`。

---

### 问题4：私钥长度没有严格检查

**通俗解释**：
就像信用卡号必须是16位数字，私钥必须是64个十六进制字符。如果你不小心输入了一个错误长度的"私钥"，代码会把它加密保存，等你要用的时候才发现根本用不了。

**技术细节**：
- `encrypt()` 函数只检查是不是有效的十六进制数，不检查长度
- 但 `verify_private_key()` 函数有完整的检查

**涉及文件**：
- `src/crypto.py` 第86-129行

**建议**：在加密前调用 `verify_private_key()` 检查。

---

### 问题5：日志可能泄露敏感信息

**通俗解释**：
就像你打电话时旁边有人在录音，WebSocket 的日志会记录收到的消息内容，如果以后扩展到用户相关的频道，可能会记录到敏感信息。

**技术细节**：
- WebSocket 在 info 级别记录消息的前200个字符
- 目前只订阅市场数据，没什么敏感信息
- 但如果以后订阅用户频道，就可能泄露订单信息

**涉及文件**：
- `src/websocket_client.py` 第490-491行

**建议**：把详细日志改成 debug 级别，或者对敏感字段脱敏。

---

### 问题6：密码强度要求太低

**通俗解释**：
你的私钥加密密码只要求8个字符，这太短了。像 `12345678` 或 `password` 这样的弱密码很容易被猜出来。

**技术细节**：
- `src/crypto.py` 只要求密码长度 >= 8
- 没有要求必须包含大小写、数字、特殊符号

**建议**：
1. 增加最小长度到12-16个字符
2. 建议用户使用密码管理器生成强密码

---

### 问题7：认证 nonce 固定为0

**通俗解释**：
nonce（随机数）就像每次交易时的"一次性密码"，防止别人重复使用你的旧交易。现在代码里固定用0，如果服务器检查不严格，可能存在"重放攻击"风险。

**技术细节**：
- `sign_auth_message()` 默认 `nonce=0`
- 目前依赖时间戳防重放，但不够严谨

**涉及文件**：
- `src/signer.py`

---

## 低危问题 (1个)

### 问题8：输入参数没有严格校验

**通俗解释**：
当你在网站上填表时，如果网站不检查你填的内容，坏人可能填入特殊字符搞破坏。虽然这个项目主要是你自己用，但养成好习惯总没错。

**技术细节**：
- `order_id`、`token_id` 等直接拼接到 URL 中
- 如果这些值来自外部（比如从文件读取），可能有路径混淆风险

**涉及文件**：
- `src/client.py`
- `src/bot.py`

**建议**：对 ID 字段进行格式校验（比如必须是十六进制）。

---

## 做得好的地方

代码中也有很多安全措施做得不错：

| 安全措施 | 说明 |
|---------|------|
| **私钥加密** | 使用 PBKDF2（48万次迭代）+ Fernet 加密，很安全 |
| **文件权限** | 加密后的私钥文件设置为 `0600`，只有你能读 |
| **签名机制** | 使用 EIP-712 类型签名，符合以太坊标准 |
| **HMAC 认证** | Builder API 使用 HMAC 签名，防篡改 |
| **订单校验** | `Order.__post_init__` 有基础的参数校验 |

---

## 我的建议（按优先级排序）

### 必须做 ✅

1. **永远不要把 `config.yaml` 提交到 Git**
   ```bash
   # 确保 .gitignore 包含：
   config.yaml
   *.enc
   credentials/
   ```

2. **使用环境变量而不是配置文件保存 API 凭证**
   ```bash
   # 在 .bashrc 或 .zshrc 中：
   export POLY_BUILDER_API_KEY=你的密钥
   export POLY_BUILDER_API_SECRET=你的密钥
   export POLY_BUILDER_API_PASSPHRASE=你的密码
   ```

3. **使用强密码加密私钥**
   - 至少16个字符
   - 包含大小写字母、数字、特殊符号
   - 用密码管理器生成

### 建议做 💡

4. **检查网络连接是 HTTPS**
   - 不要修改默认的 API 地址
   - 如果要改，确保是 `https://` 开头

5. **定期检查你的交易记录**
   - 如果发现不是你操作的交易，立即更换所有凭证

6. **使用专用钱包**
   - 不要用存有大量资产的钱包来交易
   - 只转入你愿意冒险的金额

---

## 术语解释

| 术语 | 解释 |
|------|------|
| **私钥** | 相当于你钱包的"万能钥匙"，有了它就能动你的钱 |
| **API Key** | 相当于"通行证"，证明你有权限用这个服务 |
| **API Secret** | 相当于通行证的"密码" |
| **HMAC** | 一种签名方式，用来证明消息没被篡改 |
| **PBKDF2** | 一种把简单密码变成复杂密钥的方法 |
| **Fernet** | 一种加密方法，用来保护你的私钥 |
| **nonce** | "一次性数字"，防止同一笔交易被重复执行 |
| **TLS/HTTPS** | 网络加密，防止数据在传输中被偷看 |

---

## 总结

**这个项目的安全性整体不错**，特别是私钥保护做得很好。主要需要注意的是：

1. 不要把配置文件保存到 Git
2. 使用环境变量存储 API 凭证
3. 使用强密码
4. 只用专门用于交易的小额钱包

如果你按照上面的建议操作，这个机器人是可以安全使用的。

---

*审计完成时间：2026-01-09*
*审计者：Claude + Codex*